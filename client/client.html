<!DOCTYPE html>
<html lang="en">
<head>
  <title>Monster Generator/title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

        const parseJSON = (xhr, content) => {
            if(xhr.response){

                content.innerHTML = "";

                if(xhr.getResponseHeader('Content-Type') === 'application/json'){
                    const obj = JSON.parse(xhr.response);

                    if(obj.newestMonster){
                        content.innerHTML += `<p><b>${obj.newestMonster.monster.name}</b></p>`;
                        content.innerHTML += `<p>${obj.newestMonster.monster.description}</p>`;
                        content.innerHTML += JSON.stringify(obj.newestMonster.monster.stats);
                    }
                    else if(obj.monsters){
                        let keys = Object.keys(obj.monsters);
                        for(let key of keys){
                            content.innerHTML += `<p><b>${obj.monsters[key].name}</b></p>`;
                            content.innerHTML += `<p>${obj.monsters[key].description}</p>`;
                            content.innerHTML += `<p>${JSON.stringify(obj.monsters[key].stats)}</p>`;
                        }
                    }
                }
                else if(xhr.getResponseHeader('Content-Type') === 'text/xml'){
                    const name = xhr.responseXML.querySelector('name').textContent;
                    content.innerHTML += `<p>${name}</p>`;

                    const desc = xhr.responseXML.querySelector('desc').textContent;
                    content.innerHTML += `<p>${desc}</p>`;

                    const stats = xhr.responseXML.querySelector('stats').textContent;
                    content.innerHTML += `<p>${stats}</p>`;
                }
            }
        }

        const handleResponse = (xhr, parseResponse) => {
            // const type = xhr.getResponseHeader('content-type');

            // const content = document.querySelector('#content');
            //
            //   switch(xhr.status){
            //       case 200:
            //           content.innerHTML = '<b>Success<b>';
            //           break;
            //       case 201:
            //           content.innerHTML = '<b>Created<b>';
            //           break;
            //       case 204:
            //           content.innerHTML = '<b>Updated (No Content)<b>';
            //           break;
            //       case 400:
            //           content.innerHTML = '<b>Bad Request<b>';
            //           break;
            //       case 404:
            //           content.innerHTML = '<b>Resource Not Found<b>';
            //           break;
            //       default:
            //           content.innerHTML = '<b>Error Code Not Implemented By Client<b>';
            //           break;
            //   }

            parseJSON(xhr, content);
        };

        const requestUpdate = (e, userForm) => {
            const url = userForm.getAttribute('action');
            const method = userForm.getAttribute('method');

            const xhr = new XMLHttpRequest();
            xhr.open(method, url);

            xhr.setRequestHeader('Accept', 'application/json');

            if(method === 'get'){
                xhr.onload = () => handleResponse(xhr, true);
            }
            else{
                xhr.onload = () => handleResponse(xhr, false);
            }

            xhr.send();

            e.preventDefault();
            return false;
        };

        const getChecked = (radioButtonGroup) => {
            // From https://www.javascripttutorial.net/javascript-dom/javascript-radio-button/
            let checkedResult;
            for (let result of radioButtonGroup) {
                if(result.checked){
                    checkedResult = result.value;
                    return checkedResult;
                }
            }
            return '';
        };

        const sendPost = (e, questionsForm) => {
            e.preventDefault();

            let q1 = questionsForm.querySelectorAll('input[name="q1"]');
            let q2 = questionsForm.querySelectorAll('input[name="q2"]');
            let q3 = questionsForm.querySelectorAll('input[name="q3"]');

            let q1Result = getChecked(q1);
            let q2Result = getChecked(q2);
            let q3Result = getChecked(q3);

            const questionsAction = questionsForm.getAttribute('action');
            const questionsMethod = questionsForm.getAttribute('method');

            const xhr = new XMLHttpRequest();
            xhr.open(questionsMethod, questionsAction);

            xhr.setRequestHeader('Accept', 'application/json');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = () => handleResponse(xhr, true);

            const formData = `q1=${q1Result}&q2=${q2Result}&q3=${q3Result}`;
            xhr.send(formData);

            return false;
        };

        const init = () => {
            const questionsForm = document.querySelector('#questionsForm');
            const monstersForm = document.querySelector('#monstersForm');
            const newestMonsterForm = document.querySelector('#newestMonsterForm');

            const sendQuizResults = (e) => sendPost(e, questionsForm);
            const getMonsters = (e) => requestUpdate(e, monstersForm);
            const getNewestMonster = (e) => requestUpdate(e, newestMonsterForm);

            questionsForm.addEventListener('submit', sendQuizResults);
            monstersForm.addEventListener('submit', getMonsters);
            newestMonsterForm.addEventListener('submit', getNewestMonster);
        };

        window.onload = init;

  </script>
</head>
<body>
  <section id="top">

    <h1>Monster Generator</h1>

    <form id="questionsForm" action="/generateMonster" method="post">

        <!---<fieldset id="q1">--->
          <h4>What type of creature are you seeking?</h3>
          <input id="q1a" type="radio" name="q1" value="S"/>
          <label for="q1a">Serious</label>

          <input id="q1b" type="radio" name="q1" value="C"/>
          <label for="q1b">Cute/Funny</label>

          <input id="q1c" type="radio" name="q1" value="N"/>
          <label for="q1c">Either</label>
        <!---</fieldset>--->

        <!---<fieldset id="q2">--->
          <h4>If you were to describe this creature, would you describe it as…</h3>
          <input id="q2a" type="radio" name="q2" value="Scaled"/>
          <label for="q2a">Scaled</label>

          <input id="q2b" type="radio" name="q2" value="Furred"/>
          <label for="q2b">Furred</label>

          <input id="q2c" type="radio" name="q2" value="Winged"/>
          <label for="q2c">Winged</label>

          <input id="q2d" type="radio" name="q2" value="Natural"/>
          <label for="q2d">Natural</label>

          <input id="q2e" type="radio" name="q2" value="Terrible"/>
          <label for="q2e">Terrible</label>

          <input id="q2f" type="radio" name="q2" value="ExtraPlanar"/>
          <label for="q2f">Extra-planar</label>
        <!---</fieldset>--->

        <!---<fieldset id="q3">--->
          <h4>This monster is…</h3>
          <input id="q3a" type="radio" name="q3" value="Phys"/>
          <label for="q3a">From a distant land or biome</label>

          <input id="q3b" type="radio" name="q3" value="Abil"/>
          <label for="q3b">A formidable foe, or ally</label>

          <input id="q3c" type="radio" name="q3" value="Pers"/>
          <label for="q3c">Peculiar</label>
        <!---</fieldset>--->

      <input type="submit" value="Generate"/>
    </form>

    <form id="monstersForm" action="/getMonsters" method="get">
        <input type="submit" value="Show All Monster"/>
    </form>

    <form id="newestMonsterForm" action="/getNewestMonster" method="get">
        <input type="submit" value="Show Newest Monster"/>
    </form>

  </section>
  <section id="content">
  </section>
</body>
</html>
